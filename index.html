<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>

      .bubbles {
        stroke-width: .5px;
        stroke: #3a403d;
        opacity: .8
      }
      .bubbles:hover {
        stroke: black;
        opacity: 1.0;
      }
    </style>
  </head>
  <body>
    <script src="https://d3js.org/d3.v4.js"></script>
    <script>
      var numberPersons = 7665;
      var KupferstichS = 0,
        PortraitP = 0,
        MuenzeM = 0,
        SteinmetzF = 0;
      var extra = {
        KupferstichS: 0,
        PortraitP: 0,
        MuenzeM: 0,
        SteinmetzF: 0
      };
      var extraMale = {
        KupferstichS: 0,
        PortraitP: 0,
        MuenzeM: 0,
        SteinmetzF: 0
      };
      var extraFemale = {
        KupferstichS: 0,
        PortraitP: 0,
        MuenzeM: 0,
        SteinmetzF: 0
      };

      //all persons with a picture
      var dataAll = {
        descr: "Number of people with a depiction: ",
        number: 0
      };

      //all even those without picture, hardcoded for now
      var personsAll = {
        descr: "Number of people without a depiction: ",
        number: numberPersons
      };

      var width = window.innerWidth,
        height = window.innerHeight,
        sizeDivisor = 50,
        nodePadding = 2.5;
      var svg = d3
        .select("body")
        .append("svg")
        .attr("width", width)
        .attr("height", height);
      var color = d3.scaleOrdinal([
        "#66c2a5",
        "#fc8d62",
        "#8da0cb",
        "#e78ac3",
        "#a6d854",
        "#ffd92f",
        "#e5c494",
        "#b3b3b3"
      ]);
      var simulation = d3
        .forceSimulation()
        .force(
          "forceX",
          d3
            .forceX()
            .strength(0.1)
            .x(width * 0.5)
        )
        .force(
          "forceY",
          d3
            .forceY()
            .strength(0.1)
            .y(height * 0.5)
        )
        .force(
          "center",
          d3
            .forceCenter()
            .x(width * 0.5)
            .y(height * 0.5)
        )
        .force("charge", d3.forceManyBody().strength(-15));
      d3.csv(
        "https://raw.githubusercontent.com/phuje/Data-test/master/person-abb.csv",
        function(data) {
          dataAll.number = data.length;
          dataAll.radius = data.length/sizeDivisor;
          personsAll.number = (numberPersons-dataAll.number);
          personsAll.radius = personsAll.number/sizeDivisor;
          for (var i = 0; i < data.length; i++) {
            data[i].geb = parseInt(data[i].geb);
            data[i].tod = parseInt(data[i].tod);
            data[i].alter = data[i].tod - data[i].geb;
            //console.log(data[i]);
            switch (data[i].abb) {
              case "S":
                extra.KupferstichS++;
                if (data[i].sex === "m") {
                  extraMale.KupferstichS++;
                } else if (data[i].sex === "w") {
                  extraFemale.KupferstichS++;
                }
                break;
              case "P":
                extra.PortraitP++;
                if (data[i].sex === "m") {
                  extraMale.PortraitP++;
                } else if (data[i].sex === "w") {
                  extraFemale.PortraitP++;
                }
                break;
              case "M":
                extra.MuenzeM++;
                if (data[i].sex === "m") {
                  extraMale.MuenzeM++;
                } else if (data[i].sex === "w") {
                  extraFemale.MuenzeM++;
                }
                break;
              case "F":
                extra.SteinmetzF++;
                if (data[i].sex === "m") {
                  extraMale.SteinmetzF++;
                } else if (data[i].sex === "w") {
                  extraFemale.SteinmetzF++;
                }
                break;
              default:
                break;
            }
          }
          console.log("Abbildungen Insgesamt: ", extra);
          console.log("Abbildung Male: ", extraMale);
          console.log("Abbildung Female: ", extraFemale);
          //if (error) throw error;
          // sort the nodes so that the bigger ones are at the back
          //data = data.sort(function(a,b){ return b.size - a.size; });
          //update the simulation based on the data

          var dataNode = [personsAll, dataAll];
          console.log("Node: ", dataNode);


          simulation
            .nodes(dataNode)
            .force(
              "collide",
              d3
                .forceCollide()
                .strength(0.5)
                .radius(function(d) {
                  console.log(d);
                  return d.radius + nodePadding;
                })
                .iterations(1)
            )
            .on("tick", function(d) {
              node
                .attr("cx", function(d) {
                  return d.x;
                })
                .attr("cy", function(d) {
                  return d.y;
                });
            });

            // ---------------------------//
            //      TOOLTIP               //
            // ---------------------------//

            // -1- Create a tooltip div that is hidden by default:
            var tooltip = d3.select("body")
              .append("div")
                .style("opacity", 0)
                .attr("class", "tooltip")
                .style("background-color", "black")
                .style("border-radius", "5px")
                .style("padding", "10px")
                .style("color", "white")
                .style("position", "absolute")

            // -2- Create 3 functions to show / update (when mouse move but stay on same circle) / hide the tooltip
            var showTooltip = function(d) {
              tooltip
                .transition()
                .duration(200)
              tooltip
                .style("opacity", 1)
                .html(d.descr+d.number)
                .style("left", (d3.mouse(this)[0]+30) + "px")
                .style("top", (d3.mouse(this)[1]+30) + "px")
            }
            var moveTooltip = function(d) {
              console.log("movetooltip");
              tooltip
                .style("left", (d3.mouse(this)[0]+30) + "px")
                .style("top", (d3.mouse(this)[1]+30) + "px")
            }
            var hideTooltip = function(d) {
              tooltip
                .transition()
                .duration(200)
                .style("opacity", 0)
            }


          var node = svg
            .append("g")
            .attr("class", "node")
            .selectAll("circle")
            .data(dataNode)
            .enter()
            .append("circle")
              .attr("class", function(d) { return "bubbles"/* + d.continent */})
              .attr("r", function(d) {
                return d.radius;
              })
              .attr("fill", function(d) {
                return color(d.descr);
              })
              .attr("cx", function(d) {
                return d.x;
              })
              .attr("cy", function(d) {
                return d.y;
              })
              .on("mouseover", showTooltip)
              .on("mousemove", moveTooltip )
              .on("mouseleave", hideTooltip)
              .call(
                d3
                  .drag()
                  .on("start", dragstarted)
                  .on("drag", dragged)
                  .on("end", dragended)
              );


            

        }
      );
      function dragstarted(d) {
        if (!d3.event.active) simulation.alphaTarget(0.03).restart();
        d.fx = d.x;
        d.fy = d.y;
      }
      function dragged(d) {
        d.fx = d3.event.x;
        d.fy = d3.event.y;
      }
      function dragended(d) {
        if (!d3.event.active) simulation.alphaTarget(0.03);
        d.fx = null;
        d.fy = null;
      }
      function countAbbildung(d) {
        if (d.abb !== null) {
        }
      }
      function types(d) {
        //console.log(d);
        // d.gdp = +d.gdp;
        // d.size = +d.gdp / sizeDivisor;
        // d.size < 3 ? d.radius = 3 : d.radius = d.size;
        //return d;
      }
    </script>
  </body>
</html>